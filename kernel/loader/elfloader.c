#include "elfloader.h"
#include "elf.h"
#include <mm/mmu.h>
#include <platform/riscv.h>
#include <process/proc.h>
#include <uniks/kassert.h>
#include <uniks/kstdlib.h>
#include <uniks/kstring.h>
#include <mm/phys.h>


// copy binary from user/bin/echo.o
uint32_t elfile[] = {
	0x464c457f, 0x00010102, 0x00000000, 0x00000000, 0x00f30002, 0x00000001,
	0x00010000, 0x00000000, 0x00000040, 0x00000000, 0x000023d8, 0x00000000,
	0x00000004, 0x00380040, 0x00400002, 0x0009000a, 0x00000001, 0x00000005,
	0x00001000, 0x00000000, 0x00010000, 0x00000000, 0x00010000, 0x00000000,
	0x00000902, 0x00000000, 0x00000902, 0x00000000, 0x00001000, 0x00000000,
	0x00000001, 0x00000006, 0x00002000, 0x00000000, 0x00011000, 0x00000000,
	0x00011000, 0x00000000, 0x00000011, 0x00000000, 0x00000020, 0x00000000,
	0x00001000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0xfc010113, 0x02113c23,
	0x02813823, 0x04010413, 0x00050793, 0xfcb43823, 0xfcc43423, 0xfcf42e23,
	0xfdc42783, 0xfc843603, 0xfd043583, 0x00078513, 0x55c000ef, 0x00050793,
	0xfef42623, 0xfec42783, 0x00078513, 0x061000ef, 0x00000013, 0x03813083,
	0x03013403, 0x04010113, 0x00008067, 0xfe010113, 0x00113c23, 0x00813823,
	0x02010413, 0x00050793, 0xfef407a3, 0xfef40793, 0x00100613, 0x00078593,
	0x00100513, 0x740000ef, 0x00000013, 0x01813083, 0x01013403, 0x02010113,
	0x00008067, 0xfd010113, 0x02113423, 0x02813023, 0x03010413, 0xfca43c23,
	0x0100006f, 0xfef44783, 0x00078513, 0xfa1ff0ef, 0xfd843783, 0x00178713,
	0xfce43c23, 0x0007c783, 0xfef407a3, 0xfef44783, 0x0ff7f793, 0xfc079ce3,
	0x00000013, 0x00000013, 0x02813083, 0x02013403, 0x03010113, 0x00008067,
	0xfc010113, 0x02113c23, 0x02813823, 0x04010413, 0x00050793, 0x00058693,
	0x00060713, 0xfcf42623, 0x00068793, 0xfcf42423, 0x00070793, 0xfcf42223,
	0xfe042423, 0xfc442783, 0x0007879b, 0x02078663, 0xfcc42783, 0x0007879b,
	0x0207d063, 0x00100793, 0xfef42423, 0xfcc42783, 0x40f007bb, 0x0007879b,
	0xfef42223, 0x00c0006f, 0xfcc42783, 0xfef42223, 0xfe042623, 0xfc842783,
	0xfe442703, 0x02f777bb, 0x0007861b, 0xfec42783, 0x0017871b, 0xfee42623,
	0x00011737, 0x00070693, 0x02061713, 0x02075713, 0x00e68733, 0x00074703,
	0xff040693, 0x00f687b3, 0xfee78023, 0xfc842783, 0xfe442703, 0x02f757bb,
	0xfef42223, 0xfe442783, 0x0007879b, 0xfa0794e3, 0xfe842783, 0x0007879b,
	0x02078e63, 0xfec42783, 0x0017871b, 0xfee42623, 0xff040713, 0x00f707b3,
	0x02d00713, 0xfee78023, 0x01c0006f, 0xfec42783, 0xff040713, 0x00f707b3,
	0xfe07c783, 0x00078513, 0xe55ff0ef, 0xfec42783, 0xfff7879b, 0xfef42623,
	0xfec42783, 0x0007879b, 0xfc07dae3, 0x00000013, 0x00000013, 0x03813083,
	0x03013403, 0x04010113, 0x00008067, 0xfd010113, 0x02113423, 0x02813023,
	0x03010413, 0xfca43c23, 0x000117b7, 0x8e078513, 0xe45ff0ef, 0xfe042623,
	0x03c0006f, 0xfd843783, 0x03c7d793, 0x00011737, 0x00070713, 0x00f707b3,
	0x0007c783, 0x00078513, 0xdddff0ef, 0xfec42783, 0x0017879b, 0xfef42623,
	0xfd843783, 0x00479793, 0xfcf43c23, 0xfec42783, 0x00078713, 0x00f00793,
	0xfae7fee3, 0x00000013, 0x00000013, 0x02813083, 0x02013403, 0x03010113,
	0x00008067, 0xfc010113, 0x02113c23, 0x02813823, 0x04010413, 0xfca43423,
	0xfcb43023, 0xfe042023, 0xfe042223, 0x2140006f, 0xfe442783, 0xfc843703,
	0x00f707b3, 0x0007c783, 0xfcf42e23, 0xfe042783, 0x0007879b, 0x02079a63,
	0xfdc42783, 0x0007871b, 0x02500793, 0x00f71863, 0x02500793, 0xfef42023,
	0x1cc0006f, 0xfdc42783, 0x0ff7f793, 0x00078513, 0xd2dff0ef, 0x1b80006f,
	0xfe042783, 0x0007871b, 0x02500793, 0x1af71463, 0xfdc42783, 0x0007871b,
	0x06400793, 0x02f71463, 0xfc043783, 0x00878713, 0xfce43023, 0x0007a783,
	0x00100613, 0x00a00593, 0x00078513, 0xd85ff0ef, 0x1700006f, 0xfdc42783,
	0x0007871b, 0x06c00793, 0x02f71663, 0xfc043783, 0x00878713, 0xfce43023,
	0x0007b783, 0x0007879b, 0x00000613, 0x00a00593, 0x00078513, 0xd4dff0ef,
	0x1380006f, 0xfdc42783, 0x0007871b, 0x07800793, 0x02f71463, 0xfc043783,
	0x00878713, 0xfce43023, 0x0007a783, 0x00000613, 0x01000593, 0x00078513,
	0xd19ff0ef, 0x1040006f, 0xfdc42783, 0x0007871b, 0x07000793, 0x02f71063,
	0xfc043783, 0x00878713, 0xfce43023, 0x0007b783, 0x00078513, 0xe31ff0ef,
	0x0d80006f, 0xfdc42783, 0x0007871b, 0x07300793, 0x04f71e63, 0xfc043783,
	0x00878713, 0xfce43023, 0x0007b783, 0xfef43423, 0xfe843783, 0x02079863,
	0x000117b7, 0x8e878793, 0xfef43423, 0x0200006f, 0xfe843783, 0x0007c783,
	0x00078513, 0xc01ff0ef, 0xfe843783, 0x00178793, 0xfef43423, 0xfe843783,
	0x0007c783, 0xfc079ee3, 0x0700006f, 0xfdc42783, 0x0007871b, 0x06300793,
	0x02f71263, 0xfc043783, 0x00878713, 0xfce43023, 0x0007a783, 0x0ff7f793,
	0x00078513, 0xbb9ff0ef, 0x0400006f, 0xfdc42783, 0x0007871b, 0x02500793,
	0x00f71c63, 0xfdc42783, 0x0ff7f793, 0x00078513, 0xb95ff0ef, 0x01c0006f,
	0x02500513, 0xb89ff0ef, 0xfdc42783, 0x0ff7f793, 0x00078513, 0xb79ff0ef,
	0xfe042023, 0xfe442783, 0x0017879b, 0xfef42223, 0xfe442783, 0xfc843703,
	0x00f707b3, 0x0007c783, 0xde0790e3, 0x00000013, 0x00000013, 0x03813083,
	0x03013403, 0x04010113, 0x00008067, 0xf9010113, 0x02113423, 0x02813023,
	0x03010413, 0xfca43c23, 0x00b43423, 0x00c43823, 0x00d43c23, 0x02e43023,
	0x02f43423, 0x03043823, 0x03143c23, 0x04040793, 0xfcf43823, 0xfd043783,
	0xfc878793, 0xfef43423, 0xfe843783, 0x00078593, 0xfd843503, 0xd51ff0ef,
	0x00000013, 0x02813083, 0x02013403, 0x07010113, 0x00008067, 0xfd010113,
	0x02113423, 0x02813023, 0x03010413, 0x00050793, 0xfcb43823, 0xfcf42e23,
	0xfe042623, 0x0580006f, 0xfec42783, 0x00379793, 0xfd043703, 0x00f707b3,
	0x0007b783, 0x00078593, 0x000117b7, 0x8f078513, 0xf55ff0ef, 0xfdc42783,
	0xfff7879b, 0x0007871b, 0xfec42783, 0x0007879b, 0x00e7d863, 0x000117b7,
	0x8f878513, 0xf31ff0ef, 0xfec42783, 0x0017879b, 0xfef42623, 0xfec42703,
	0xfdc42783, 0x0007071b, 0x0007879b, 0xf8f74ee3, 0x000117b7, 0x90078513,
	0xf05ff0ef, 0x00000013, 0x00078513, 0x02813083, 0x02013403, 0x03010113,
	0x00008067, 0xf9010113, 0x02813423, 0x03010413, 0xfca43c23, 0x00b43423,
	0x00c43823, 0x00d43c23, 0x02e43023, 0x02f43423, 0x03043823, 0x03143c23,
	0x04040793, 0xfcf43823, 0xfd043783, 0xfc878793, 0xfef43423, 0xfe843783,
	0x00878713, 0xfee43423, 0x0007b783, 0x00078513, 0xfe843783, 0x00878713,
	0xfee43423, 0x0007b783, 0x00078593, 0xfe843783, 0x00878713, 0xfee43423,
	0x0007b783, 0x00078613, 0xfe843783, 0x00878713, 0xfee43423, 0x0007b783,
	0x00078693, 0xfe843783, 0x00878713, 0xfee43423, 0x0007b783, 0x00078713,
	0xfe843783, 0x00878813, 0xff043423, 0x0007b783, 0xfd843883, 0x00000073,
	0x00050793, 0x00078513, 0x02813403, 0x07010113, 0x00008067, 0xff010113,
	0x00113423, 0x00813023, 0x01010413, 0x00200513, 0xf1dff0ef, 0x00050793,
	0x0007879b, 0x00078513, 0x00813083, 0x00013403, 0x01010113, 0x00008067,
	0xff010113, 0x00113423, 0x00813023, 0x01010413, 0x01400513, 0xee9ff0ef,
	0x00050793, 0x0007879b, 0x00078513, 0x00813083, 0x00013403, 0x01010113,
	0x00008067, 0xfd010113, 0x02113423, 0x02813023, 0x03010413, 0x00050793,
	0xfeb43023, 0xfcc43c23, 0xfef42623, 0xfd843683, 0xfe043603, 0x00000593,
	0x00300513, 0xe99ff0ef, 0x00050793, 0x0007879b, 0x00078513, 0x02813083,
	0x02013403, 0x03010113, 0x00008067, 0xfd010113, 0x02113423, 0x02813023,
	0x03010413, 0x00050793, 0xfeb43023, 0xfcc43c23, 0xfef42623, 0xfd843683,
	0xfe043603, 0x00000593, 0x00400513, 0xe49ff0ef, 0x00050793, 0x0007879b,
	0x00078513, 0x02813083, 0x02013403, 0x03010113, 0x00008067, 0xfe010113,
	0x00113c23, 0x00813823, 0x02010413, 0x00050793, 0xfef42623, 0xfec42783,
	0x00078593, 0x00d00513, 0xe05ff0ef, 0x00050793, 0x0007879b, 0x00078513,
	0x01813083, 0x01013403, 0x02010113, 0x00008067, 0xfe010113, 0x00113c23,
	0x00813823, 0x02010413, 0x00050793, 0xfeb43023, 0xfef42623, 0xfec42783,
	0xfe043603, 0x00078593, 0x00700513, 0xdb9ff0ef, 0x00050793, 0x0007879b,
	0x00078513, 0x01813083, 0x01013403, 0x02010113, 0x00008067, 0xfe010113,
	0x00113c23, 0x00813823, 0x02010413, 0x00050793, 0xfef42623, 0xfec42783,
	0x00078593, 0x00100513, 0xd75ff0ef, 0x00000013, 0x01813083, 0x01013403,
	0x02010113, 0x00008067, 0x00007830, 0x00000000, 0x6c756e28, 0x0000296c,
	0x00007325, 0x00000000, 0x00000020, 0x00000000, 0x0000000a, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x33323130, 0x37363534, 0x62613938, 0x66656463,
	0x43434700, 0x5328203a, 0x76694669, 0x43472065, 0x654d2d43, 0x206c6174,
	0x322e3031, 0x322d302e, 0x2e303230, 0x382e3231, 0x30312029, 0x302e322e,
	0x002f4100, 0x69720000, 0x00766373, 0x00002501, 0x05100400, 0x34367672,
	0x30703269, 0x70326d5f, 0x32615f30, 0x665f3070, 0x5f307032, 0x30703264,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00010003, 0x00010000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00020003, 0x000108e0, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00030003, 0x00011000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00040003, 0x00011011, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00050003, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00060003, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000001, 0xfff10004, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000008, 0x00030001, 0x00011000, 0x00000000,
	0x00000011, 0x00000000, 0x0000000f, 0x00010002, 0x000100f8, 0x00000000,
	0x00000144, 0x00000000, 0x00000018, 0x00010002, 0x0001023c, 0x00000000,
	0x00000088, 0x00000000, 0x00000021, 0x00010002, 0x000102c4, 0x00000000,
	0x00000260, 0x00000000, 0x00000029, 0xfff10004, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000030, 0xfff10004, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x0000003b, 0x00010002, 0x0001063c, 0x00000000,
	0x000000d0, 0x00000000, 0x00000043, 0x00010012, 0x00010858, 0x00000000,
	0x0000004c, 0x00000000, 0x00000022, 0x00010012, 0x00010524, 0x00000000,
	0x00000068, 0x00000000, 0x0000004b, 0x00010012, 0x00010740, 0x00000000,
	0x00000034, 0x00000000, 0x00000052, 0x00010012, 0x000107c4, 0x00000000,
	0x00000050, 0x00000000, 0x00000058, 0x00010012, 0x00010000, 0x00000000,
	0x0000005c, 0x00000000, 0x0000005f, 0x00010012, 0x00010774, 0x00000000,
	0x00000050, 0x00000000, 0x00000064, 0x00010012, 0x0001070c, 0x00000000,
	0x00000034, 0x00000000, 0x00000069, 0x00010012, 0x0001058c, 0x00000000,
	0x000000b0, 0x00000000, 0x0000006e, 0x00010012, 0x0001005c, 0x00000000,
	0x00000040, 0x00000000, 0x00000073, 0x00010012, 0x0001009c, 0x00000000,
	0x0000005c, 0x00000000, 0x00000079, 0x00010012, 0x000108a4, 0x00000000,
	0x0000003c, 0x00000000, 0x0000007e, 0x00010012, 0x00010814, 0x00000000,
	0x00000044, 0x00000000, 0x696c7500, 0x00632e62, 0x69676964, 0x70007374,
	0x746e6972, 0x00746e69, 0x6e697270, 0x72747074, 0x72707600, 0x66746e69,
	0x68636500, 0x00632e6f, 0x73797375, 0x6c6c6163, 0x7300632e, 0x61637379,
	0x77006c6c, 0x70746961, 0x67006469, 0x69707465, 0x72770064, 0x00657469,
	0x6174735f, 0x72007472, 0x00646165, 0x6b726f66, 0x69616d00, 0x7570006e,
	0x6b006374, 0x73747570, 0x69786500, 0x736d0074, 0x7065656c, 0x732e0000,
	0x61746d79, 0x732e0062, 0x61747274, 0x732e0062, 0x72747368, 0x00626174,
	0x7865742e, 0x722e0074, 0x7461646f, 0x642e0061, 0x00617461, 0x7373622e,
	0x6f632e00, 0x6e656d6d, 0x722e0074, 0x76637369, 0x7474612e, 0x75626972,
	0x00736574, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x0000001b, 0x00000001, 0x00000006, 0x00000000, 0x00010000, 0x00000000,
	0x00001000, 0x00000000, 0x000008e0, 0x00000000, 0x00000000, 0x00000000,
	0x00000004, 0x00000000, 0x00000000, 0x00000000, 0x00000021, 0x00000001,
	0x00000002, 0x00000000, 0x000108e0, 0x00000000, 0x000018e0, 0x00000000,
	0x00000022, 0x00000000, 0x00000000, 0x00000000, 0x00000008, 0x00000000,
	0x00000000, 0x00000000, 0x00000029, 0x00000001, 0x00000003, 0x00000000,
	0x00011000, 0x00000000, 0x00002000, 0x00000000, 0x00000011, 0x00000000,
	0x00000000, 0x00000000, 0x00000008, 0x00000000, 0x00000000, 0x00000000,
	0x0000002f, 0x00000008, 0x00000003, 0x00000000, 0x00011011, 0x00000000,
	0x00002011, 0x00000000, 0x0000000f, 0x00000000, 0x00000000, 0x00000000,
	0x00000001, 0x00000000, 0x00000000, 0x00000000, 0x00000034, 0x00000001,
	0x00000030, 0x00000000, 0x00000000, 0x00000000, 0x00002011, 0x00000000,
	0x00000030, 0x00000000, 0x00000000, 0x00000000, 0x00000001, 0x00000000,
	0x00000001, 0x00000000, 0x0000003d, 0x70000003, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00002041, 0x00000000, 0x00000030, 0x00000000,
	0x00000000, 0x00000000, 0x00000001, 0x00000000, 0x00000000, 0x00000000,
	0x00000001, 0x00000002, 0x00000000, 0x00000000, 0x00000000, 0x00000000,
	0x00002078, 0x00000000, 0x00000288, 0x00000000, 0x00000008, 0x0000000f,
	0x00000008, 0x00000000, 0x00000018, 0x00000000, 0x00000009, 0x00000003,
	0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00002300, 0x00000000,
	0x00000085, 0x00000000, 0x00000000, 0x00000000, 0x00000001, 0x00000000,
	0x00000000, 0x00000000, 0x00000011, 0x00000003, 0x00000000, 0x00000000,
	0x00000000, 0x00000000, 0x00002385, 0x00000000, 0x0000004f, 0x00000000,
	0x00000000, 0x00000000, 0x00000001, 0x00000000, 0x00000000, 0x00000000,
};


extern int32_t mappages(pagetable_t pagetable, uintptr_t va, size_t size,
			uintptr_t pa, int32_t perm, int8_t recordref);

static int32_t elf_validate(struct Elf64_Ehdr_t *elf_header)
{
	if (memcmp(&elf_header->e_ident, ELFMAGIC, 4))
		return 0;
	if (elf_header->e_ident[EI_CLASS] != ELFCLASS64)
		return 0;
	if (elf_header->e_ident[EI_DATA] != ELFDATA2LSB)
		return 0;
	if (elf_header->e_ident[EI_VERSION] != EV_CURRENT)
		return 0;
	if (elf_header->e_type != ET_EXEC)
		return 0;
	if (elf_header->e_machine != EM_RISCV)
		return 0;
	if (elf_header->e_version != EV_CURRENT)
		return 0;
	if (elf_header->e_phentsize != sizeof(struct Elf64_Phdr_t))
		return 0;
	return 1;
}

// todo: lazy record, namely mm_struct in Linux
static void load_segment(struct m_inode_t *inode,
			 struct Elf64_Phdr_t *prgm_header)
{
	assert(prgm_header->p_align == PGSIZE);		      // align to page
	assert((prgm_header->p_vaddr & (PGSIZE - 1)) == 0);   // align to page
	uintptr_t vaddr_start = prgm_header->p_vaddr;
	int32_t perm = PTE_U;

	if (get_variable_bit(prgm_header->p_flags, PF_X))
		set_variable_bit(perm, PTE_X);
	if (get_variable_bit(prgm_header->p_flags, PF_R))
		set_variable_bit(perm, PTE_R);
	if (get_variable_bit(prgm_header->p_flags, PF_W))
		set_variable_bit(perm, PTE_W);

	// page number acquired
	int64_t count = div_round_up(
		MAX(prgm_header->p_memsz, prgm_header->p_filesz), PGSIZE);

	assert(count == 1);   // hint: temporarily only support 1 page mapping
	char *pgstart = pages_alloc(1);

	// do mapping addr to physical memory
	mappages(myproc()->pagetable, vaddr_start, PGSIZE * count,
		 (uintptr_t)pgstart, perm, 1);
	memcpy(pgstart, (char *)elfile + prgm_header->p_offset,
	       prgm_header->p_filesz);

	if (prgm_header->p_filesz < prgm_header->p_memsz) {
		// .bss section need to be set as 0!
		memset(pgstart + prgm_header->p_filesz, 0,
		       prgm_header->p_memsz - prgm_header->p_filesz);
	}
}

/**
 * @brief
 *
 * @param inode
 * @return uint64_t: the entry of ELF file
 */
uint64_t load_elf(struct m_inode_t *inode)
{
	struct Elf64_Ehdr_t *elf_header = (struct Elf64_Ehdr_t *)elfile;
	if (!elf_validate(elf_header))
		return -INVALID_ELFFORMAT;
	struct Elf64_Phdr_t *prgm_header =
		(struct Elf64_Phdr_t *)((char *)elfile + elf_header->e_phoff);
	for (int32_t i = 0; i < elf_header->e_phnum; i++) {
		if (prgm_header->p_type == PT_LOAD)
			load_segment(inode, prgm_header++);
	}
	return elf_header->e_entry;
}